<?php
namespace JosephG\Roko\Infrastructure\WordPress\Repository;

use JosephG\Roko\Domain\Security\KnownVulnerabilities\Repository\VulnerabilityRepositoryInterface;
use JosephG\Roko\Domain\Security\KnownVulnerabilities\Entity\Vulnerability;
use JosephG\Roko\Domain\Security\KnownVulnerabilities\ValueObject\CvE;

final class WpVulnerabilityRepository implements VulnerabilityRepositoryInterface {

	public function latestKnown( int $limit = 10 ): array {
		// placeholder: pull from WPScan API or cached option
		$data = get_transient( 'roko_vuln_feed' ) ?: array();
		return array_slice(
			array_map(
				fn( $row ) => new Vulnerability(
					$row['plugin'] ?? 'unknown',
					new CvE( $row['cve'] ?? '0000-0000' ),
					$row['severity'] ?? 'low',
					new DateTimeImmutable( $row['published'] ?? 'now' )
				),
				$data
			),
			0,
			$limit
		);
	}
}
